<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Выравнивание вариантов</title>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #ffffff;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .title {
      font-size: 14px;
      font-weight: 600;
      color: #000000;
      margin: 0;
    }
    
    .description {
      font-size: 12px;
      color: #666666;
      margin: 0;
      line-height: 1.4;
    }
    
    .selection-info {
      background: #f0f7ff;
      border: 1px solid #b3d9ff;
      border-radius: 6px;
      padding: 12px;
      font-size: 12px;
    }
    
    .selection-info.no-selection {
      background: #fff7f0;
      border-color: #ffcc99;
    }
    
    .selection-info.no-selection .info-title {
      color: #cc6600;
    }
    
    .info-title {
      font-weight: 600;
      color: #0066cc;
      margin-bottom: 4px;
    }
    
    .info-details {
      color: #666666;
      font-size: 11px;
    }
    
    .settings {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .setting-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .setting-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .setting-label {
      font-size: 12px;
      font-weight: 500;
      color: #333333;
    }
    
    .setting-input, .setting-select {
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 12px;
      background: #ffffff;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .setting-input:focus, .setting-select:focus {
      border-color: #0d99ff;
    }
    
    .setting-select {
      cursor: pointer;
    }
    
    .setting-select:disabled {
      background: #f5f5f5;
      color: #999999;
      cursor: not-allowed;
    }
    
    .grouping-section {
      background: #f9f9f9;
      border-radius: 6px;
      padding: 12px;
      border: 1px solid #e0e0e0;
    }
    
    .grouping-section.disabled {
      opacity: 0.6;
    }
    
    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: #333333;
      margin-bottom: 8px;
    }
    
    .multi-select {
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #ffffff;
      max-height: 120px;
      overflow-y: auto;
      padding: 4px;
    }
    
    .multi-select.disabled {
      background: #f5f5f5;
      border-color: #d0d0d0;
    }
    
    .property-option {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 3px;
      transition: background-color 0.2s;
    }
    
    .property-option:hover {
      background: #f0f0f0;
    }
    
    .property-option.disabled {
      cursor: not-allowed;
      color: #999;
    }
    
    .property-option input[type="checkbox"] {
      margin: 0;
    }
    
    .group-info {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      font-style: italic;
    }
    
    .radio-group {
      display: flex;
      gap: 12px;
      margin-top: 4px;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      cursor: pointer;
      color: #333333;
    }
    
    .radio-option input[type="radio"] {
      margin: 0;
      cursor: pointer;
    }
    
    .setting-row input[type="checkbox"] {
      margin: 0;
      cursor: pointer;
    }
    
    .refresh-btn {
      padding: 4px 8px;
      background: #f0f0f0;
      border: 1px solid #d0d0d0;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      color: #666666;
      margin-left: 8px;
      transition: background-color 0.2s;
    }
    
    .refresh-btn:hover {
      background: #e0e0e0;
    }
    
    .refresh-btn:disabled {
      background: #f8f8f8;
      color: #cccccc;
      cursor: not-allowed;
    }
    
    .features {
      background: #f7f7f7;
      border-radius: 6px;
      padding: 12px;
      font-size: 12px;
      color: #333333;
    }
    
    .feature {
      margin: 4px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .feature::before {
      content: "✓";
      color: #00aa00;
      font-weight: bold;
    }
    
    .buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .button {
      flex: 1;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .button-primary {
      background: #0d99ff;
      color: white;
    }
    
    .button-primary:hover {
      background: #0b7ce6;
    }
    
    .button-primary:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    
    .button-secondary {
      background: #f0f0f0;
      color: #333333;
    }
    
    .button-secondary:hover {
      background: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">Выравнивание вариантов компонента</h1>
    
    <p class="description">
      Выберите набор компонентов (Component Set) или отдельный компонент внутри набора, 
      настройте параметры и нажмите "Выровнять".
    </p>
    
    <div class="selection-info" id="selection-info">
      <div class="info-title" id="info-title">Выберите компонент</div>
      <div class="info-details" id="info-details">Выделите Component Set или компонент внутри набора</div>
    </div>
    
    <div class="settings">
      <div class="setting-group">
        <label class="setting-label" for="padding-input">Паддинг (px):</label>
        <input 
          type="number" 
          id="padding-input" 
          class="setting-input" 
          value="40" 
          min="0" 
          max="200"
          placeholder="40"
        >
      </div>
      
      <div class="setting-group">
        <label class="setting-label" for="spacing-input">Отступ между вариантами (px):</label>
        <input 
          type="number" 
          id="spacing-input" 
          class="setting-input" 
          value="20" 
          min="0" 
          max="200"
          placeholder="20"
        >
      </div>
      
      <div class="setting-group">
        <label class="setting-label" for="column-spacing-input">Отступ между колонками (px):</label>
        <input 
          type="number" 
          id="column-spacing-input" 
          class="setting-input" 
          value="40" 
          min="0" 
          max="200"
          placeholder="40"
        >
      </div>
      
      <div class="setting-group">
        <label class="setting-label" for="group-spacing-input">Отступ между группами (px):</label>
        <input 
          type="number" 
          id="group-spacing-input" 
          class="setting-input" 
          value="80" 
          min="0" 
          max="300"
          placeholder="80"
        >
      </div>
      
      <div class="setting-group">
        <label class="setting-label" for="groups-per-row-input">Максимум групп в строке:</label>
        <input 
          type="number" 
          id="groups-per-row-input" 
          class="setting-input" 
          value="3" 
          min="1" 
          max="10"
          placeholder="3"
        >
      </div>

      <div class="setting-group">
        <div class="setting-row">
          <input type="checkbox" id="show-annotations-checkbox" checked>
          <label class="setting-label" for="show-annotations-checkbox">Показывать аннотации</label>
        </div>
        <div class="group-info">Добавлять подписи к вариантам, колонкам и группам</div>
      </div>
      
      <div class="setting-group">
        <label class="setting-label">Направление колонок внутри групп:</label>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="column-direction" value="horizontal" checked>
            <span>По горизонтали</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="column-direction" value="vertical">
            <span>По вертикали</span>
          </label>
        </div>
      </div>
    </div>
    
    <div class="grouping-section" id="grouping-section">
      <div class="section-title">
        Группировка по свойствам
        <button class="refresh-btn" id="refresh-properties-btn" disabled>Обновить</button>
      </div>
      
      <div class="setting-group">
        <label class="setting-label">Свойства для создания групп:</label>
        <div class="multi-select disabled" id="group-properties-list">
          <div class="property-option disabled">
            <input type="checkbox" disabled>
            <span>Нет доступных свойств</span>
          </div>
        </div>
        <div class="group-info" id="group-info">Выберите свойства для создания групп колонок</div>
      </div>
      
      <div class="setting-group">
        <label class="setting-label" for="column-property-select">Свойство для колонок внутри групп:</label>
        <select id="column-property-select" class="setting-select" disabled>
          <option value="none">Выберите свойство для колонок</option>
        </select>
      </div>
    </div>
    
    <div class="features">
      <div class="feature">Многоуровневая группировка по нескольким свойствам</div>
      <div class="feature">Горизонтальное и вертикальное направление колонок</div>
      <div class="feature">Настраиваемые отступы между колонками и группами</div>
      <div class="feature">Автоматический перенос групп на новую строку</div>
      <div class="feature">Синхронная сортировка внутри групп</div>
      <div class="feature">Автоматический расчет размеров</div>
      <div class="feature">Умные аннотации с линиями границ групп</div>
      <div class="feature">Сохранение настроек для каждого компонента</div>
    </div>
    
    <div class="buttons">
      <button class="button button-primary" id="align-btn" disabled>Выровнять</button>
      <button class="button button-secondary" id="cancel-btn">Отмена</button>
    </div>
  </div>

  <script>
    let availableProperties = [];
    let hasValidSelection = false;
    
    // Функция для загрузки настроек в UI
    function loadSettingsToUI(settings) {
      if (!settings) return;
      
      // Загружаем основные настройки
      document.getElementById('padding-input').value = settings.padding || 40;
      document.getElementById('spacing-input').value = settings.spacing || 20;
      document.getElementById('column-spacing-input').value = settings.columnSpacing || 40;
      document.getElementById('group-spacing-input').value = settings.groupSpacing || 80;
      document.getElementById('groups-per-row-input').value = settings.groupsPerRow || 3;
      document.getElementById('show-annotations-checkbox').checked = settings.showAnnotations !== false;
      
      // Загружаем направление колонок
      const columnDirectionRadios = document.querySelectorAll('input[name="column-direction"]');
      columnDirectionRadios.forEach(radio => {
        radio.checked = radio.value === (settings.columnDirection || 'horizontal');
      });
      
      // Загружаем выбранные свойства групп (будет применено после загрузки свойств)
      window.pendingGroupProperties = settings.groupProperties || [];
      window.pendingColumnProperty = settings.columnProperty || null;
    }

    // Функция для применения отложенных настроек группировки
    function applyPendingGroupSettings() {
      // Применяем выбранные свойства групп
      if (window.pendingGroupProperties && window.pendingGroupProperties.length > 0) {
        window.pendingGroupProperties.forEach(property => {
          const checkbox = document.getElementById(`group-prop-${property}`);
          if (checkbox) {
            checkbox.checked = true;
          }
        });
        updateGroupInfo();
      }
      
      // Применяем выбранное свойство колонок
      if (window.pendingColumnProperty) {
        const columnSelect = document.getElementById('column-property-select');
        columnSelect.value = window.pendingColumnProperty;
      }
      
      // Очищаем отложенные настройки
      window.pendingGroupProperties = null;
      window.pendingColumnProperty = null;
    }

    // Функция для обновления информации о выделении
    function updateSelectionInfo(data) {
      const infoContainer = document.getElementById('selection-info');
      const infoTitle = document.getElementById('info-title');
      const infoDetails = document.getElementById('info-details');
      const groupingSection = document.getElementById('grouping-section');
      const alignBtn = document.getElementById('align-btn');
      const refreshBtn = document.getElementById('refresh-properties-btn');
      const groupPropertiesList = document.getElementById('group-properties-list');
      const columnPropertySelect = document.getElementById('column-property-select');
      
      hasValidSelection = data.hasValidSelection;
      
      if (data.hasValidSelection) {
        infoContainer.className = 'selection-info';
        
        // Показываем статус сохраненных настроек
        const settingsStatus = data.savedSettings ? ' • настройки сохранены' : ' • новый компонент';
        infoTitle.textContent = `📦 ${data.componentSetName}`;
        infoDetails.textContent = `${data.variantCount} вариантов • ${data.properties.length} свойств${settingsStatus}`;
        
        groupingSection.classList.remove('disabled');
        alignBtn.disabled = false;
        refreshBtn.disabled = false;
        groupPropertiesList.classList.remove('disabled');
        columnPropertySelect.disabled = false;
        
        updatePropertiesControls(data.properties);
        
        // Загружаем сохраненные настройки
        if (data.savedSettings) {
          loadSettingsToUI(data.savedSettings);
        }
      } else {
        infoContainer.className = 'selection-info no-selection';
        infoTitle.textContent = 'Выберите компонент';
        infoDetails.textContent = 'Выделите Component Set или компонент внутри набора';
        
        groupingSection.classList.add('disabled');
        alignBtn.disabled = true;
        refreshBtn.disabled = true;
        groupPropertiesList.classList.add('disabled');
        columnPropertySelect.disabled = true;
        
        updatePropertiesControls([]);
      }
    }
    
    // Функция для обновления контролов свойств
    function updatePropertiesControls(properties) {
      const groupPropertiesList = document.getElementById('group-properties-list');
      const columnPropertySelect = document.getElementById('column-property-select');
      const groupInfo = document.getElementById('group-info');
      
      // Обновляем список свойств для групп
      groupPropertiesList.innerHTML = '';
      
      if (properties.length === 0) {
        const option = document.createElement('div');
        option.className = 'property-option disabled';
        option.innerHTML = '<input type="checkbox" disabled><span>Нет доступных свойств</span>';
        groupPropertiesList.appendChild(option);
        groupInfo.textContent = 'Выберите компонент для просмотра свойств';
      } else {
        properties.forEach(property => {
          const option = document.createElement('div');
          option.className = 'property-option';
          option.innerHTML = `
            <input type="checkbox" id="group-prop-${property}" value="${property}">
            <label for="group-prop-${property}">${property}</label>
          `;
          groupPropertiesList.appendChild(option);
          
          // Добавляем обработчик изменения
          const checkbox = option.querySelector('input');
          checkbox.addEventListener('change', updateGroupInfo);
        });
        groupInfo.textContent = 'Выберите свойства для создания групп колонок';
      }
      
      // Обновляем селект свойств для колонок
      while (columnPropertySelect.children.length > 1) {
        columnPropertySelect.removeChild(columnPropertySelect.lastChild);
      }
      
      properties.forEach(property => {
        const option = document.createElement('option');
        option.value = property;
        option.textContent = property;
        columnPropertySelect.appendChild(option);
      });
      
      availableProperties = properties;
      
      // Применяем отложенные настройки группировки если они есть
      applyPendingGroupSettings();
    }
    
    // Функция для обновления информации о группах
    function updateGroupInfo() {
      const groupInfo = document.getElementById('group-info');
      const selectedProperties = getSelectedGroupProperties();
      
      if (selectedProperties.length === 0) {
        groupInfo.textContent = 'Выберите свойства для создания групп колонок';
      } else {
        groupInfo.textContent = `Выбрано свойств для групп: ${selectedProperties.join(', ')}`;
      }
    }
    
    // Функция для получения выбранных свойств для групп
    function getSelectedGroupProperties() {
      const checkboxes = document.querySelectorAll('#group-properties-list input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }
    
    // Обработчики событий
    document.getElementById('align-btn').addEventListener('click', () => {
      if (!hasValidSelection) {
        return;
      }
      
      const padding = parseInt(document.getElementById('padding-input').value) || 40;
      const spacing = parseInt(document.getElementById('spacing-input').value) || 20;
      const columnSpacing = parseInt(document.getElementById('column-spacing-input').value) || 40;
      const groupSpacing = parseInt(document.getElementById('group-spacing-input').value) || 80;
      const groupsPerRow = parseInt(document.getElementById('groups-per-row-input').value) || 3;
      const columnDirection = document.querySelector('input[name="column-direction"]:checked').value;
      const groupProperties = getSelectedGroupProperties();
      const columnProperty = document.getElementById('column-property-select').value;
      const showAnnotations = document.getElementById('show-annotations-checkbox').checked;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'align-variants',
          padding: padding,
          spacing: spacing,
          columnSpacing: columnSpacing,
          groupSpacing: groupSpacing,
          groupsPerRow: groupsPerRow,
          columnDirection: columnDirection,
          groupProperties: groupProperties,
          columnProperty: columnProperty === 'none' ? null : columnProperty,
          showAnnotations: showAnnotations
        } 
      }, '*');
    });
    
    document.getElementById('cancel-btn').addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    });
    
    document.getElementById('refresh-properties-btn').addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'get-properties' } }, '*');
    });
    
    // Обработчик сообщений от плагина
    window.addEventListener('message', (event) => {
      const msg = event.data.pluginMessage;
      if (msg && msg.type === 'selection-updated') {
        updateSelectionInfo(msg.data);
      }
    });
    
    // Валидация ввода
    const inputs = document.querySelectorAll('.setting-input');
    inputs.forEach(input => {
      input.addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        
        if (e.target.id === 'group-spacing-input') {
          if (value < 0) e.target.value = 0;
          if (value > 300) e.target.value = 300;
        } else if (e.target.id === 'groups-per-row-input') {
          if (value < 1) e.target.value = 1;
          if (value > 10) e.target.value = 10;
        } else {
          if (value < 0) e.target.value = 0;
          if (value > 200) e.target.value = 200;
        }
      });
    });
  </script>
</body>
</html> 